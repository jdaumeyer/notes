<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-03-01 Wed 10:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Threads</title>
<meta name="author" content="Jackson Daumeyer" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://jdaumeyer.github.io/notes/css/style.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Threads
<br />
<span class="subtitle">Chapter 4</span>
</h1>
<p>
We can Parallelize both Processes and Data
</p>

<div id="outline-container-orgf5f8f2f" class="outline-2">
<h2 id="orgf5f8f2f">Threads vs Processes</h2>
<div class="outline-text-2" id="text-orgf5f8f2f">
<p>
Processes are resource intensive being a copy of the original program, so why not try Process Lite with the same big flavor!
</p>
<ul class="org-ul">
<li>We avoid the overhead of creating a <b>process</b> by using <b>threads</b> instead</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Aspect</th>
<th scope="col" class="org-left">Processes</th>
<th scope="col" class="org-left">Threads</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>Responsiveness</b></td>
<td class="org-left">Must wait for process completion before moving to the next</td>
<td class="org-left">A program&rsquo;s threads can run even if others are waiting</td>
</tr>

<tr>
<td class="org-left"><b>Resource Sharing</b></td>
<td class="org-left">Must use communication to share</td>
<td class="org-left">Automatically share resources</td>
</tr>

<tr>
<td class="org-left"><b>Economy</b></td>
<td class="org-left">Creating a process is expensive</td>
<td class="org-left">Creating a thread is inexpensive</td>
</tr>

<tr>
<td class="org-left"><b>Scalability</b></td>
<td class="org-left">One process can only ever run on one core</td>
<td class="org-left">Multiple threads can make use of all cores</td>
</tr>

<tr>
<td class="org-left"><b>Termination</b></td>
<td class="org-left">When the parent is killed children can keep running</td>
<td class="org-left">Threads die with their parent</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>Threads go away when the parent is killed, processes are orphaned</li>
</ul>
</div>
<div id="outline-container-org628f1ae" class="outline-3">
<h3 id="org628f1ae">Multicore Systems</h3>
<div class="outline-text-3" id="text-org628f1ae">
<p>
On systems that are <b>multicore</b>, meaning we have <i>cores</i> that look like several separate CPUs <b>threads</b> can run in parallel. So instead of one process running on one core, the threads of a process can all run in parallel on their own cores.
</p>

<p>
Note there is a difference between <i>parallelism</i> and <i>concurrency</i> that we have to keep in mind:
</p>
<dl class="org-dl">
<dt>Parallelism</dt><dd>Means that a system can perform more than one task at a time</dd>
<dt>Concurrency</dt><dd>Only <i>appears</i> to be running multiple tasks by switching them out and continuously making progress</dd>
</dl>
</div>
<div id="outline-container-orgad48b91" class="outline-4">
<h4 id="orgad48b91">Amdahl&rsquo;s Law</h4>
<div class="outline-text-4" id="text-orgad48b91">
<p>
<b>Amdahl&rsquo;s Law</b> shows us that the serial portion of a process has more of an effect as we add more cores. Because as we add cores the time of the parallel sections decreases, and more of our total runtime is taken up by serial sections.
\(speedup \le \frac{1}{S + \frac{(1 -S)}{N}}\)
</p>
<ul class="org-ul">
<li>\(N\) is the number of cores</li>
<li>\(S\) is the time of the serial portion</li>
</ul>
<p>
So as \(N \rightarrow \infty\) the speedup approaches \(\frac{1}{S}\).
</p>
</div>
</div>

<div id="outline-container-org10adc79" class="outline-4">
<h4 id="org10adc79">Types of Parallelism</h4>
<div class="outline-text-4" id="text-org10adc79">
<dl class="org-dl">
<dt>Data Parallelism</dt><dd>The same data is distributed across multiple cores</dd>
<dt>Task Parallelism</dt><dd>Tasks/Threads are distributed across multiple cores</dd>
</dl>
</div>
</div>
</div>
</div>

<div id="outline-container-org5180fcd" class="outline-2">
<h2 id="org5180fcd">Threads</h2>
<div class="outline-text-2" id="text-org5180fcd">
<p>
There are two types of threads that exist in our systems <b>Kernel Threads</b> and <b>User Threads</b>
</p>
<dl class="org-dl">
<dt>User Threads</dt><dd>User-level threads are things that exist in the user space and are managed without kernel support.</dd>
<dt>Kernel Threads</dt><dd>Threads supported by the kernel and managed directly by the Operating System.</dd>
</dl>
</div>

<div id="outline-container-org8b57d54" class="outline-3">
<h3 id="org8b57d54">Multithreading Models</h3>
<div class="outline-text-3" id="text-org8b57d54">
<p>
Each <b>user thread</b> has to be mapped to a corresponding <b>kernel thread</b> in some fashion
</p>
</div>
<div id="outline-container-org22209cc" class="outline-4">
<h4 id="org22209cc">Many-to-One</h4>
<div class="outline-text-4" id="text-org22209cc">
<p>
Maps multiple user threads to a single kernel thread.
</p>
<ul class="org-ul">
<li>Today it&rsquo;s not very common because it doesn&rsquo;t take full advantage of multiple processing cores</li>
<li>If a <b>user thread</b> makes a blocking call, none of the other threads mapped to the same <b>kernel thread</b> can progress</li>
</ul>
</div>
</div>
<div id="outline-container-org0fcd920" class="outline-4">
<h4 id="org0fcd920">One-to-One</h4>
<div class="outline-text-4" id="text-org0fcd920">
<p>
Each user thread is supported by its own dedicated kernel thread.
</p>
<ul class="org-ul">
<li>Overhead caused by having to essentially create two threads (a <i>user</i> and a <i>kernel</i>) every time</li>
<li>High coherency and parallelism</li>
<li>There has to be some limit to the number of kernel threads allowed to be created</li>
</ul>
</div>
</div>
<div id="outline-container-orga4e8eac" class="outline-4">
<h4 id="orga4e8eac">Many-to-Many</h4>
<div class="outline-text-4" id="text-orga4e8eac">
<p>
Many <b>user threads</b> are mapped to many <b>kernel threads</b>
</p>
<ul class="org-ul">
<li>Should be the ideal case, not compromising in any way, but it is rarely seen on real systems</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfed9cac" class="outline-3">
<h3 id="orgfed9cac">Thread Libraries</h3>
<div class="outline-text-3" id="text-orgfed9cac">
<p>
My notes are a little bare here since we don&rsquo;t need to know the intricacies of specific libraries/implementations
</p>
</div>
<div id="outline-container-orgec46280" class="outline-4">
<h4 id="orgec46280">Pthreads</h4>
<div class="outline-text-4" id="text-orgec46280">
<p>
This is the <i>POSIX Specification</i> for how threads should be created.
</p>
</div>
</div>
<div id="outline-container-org811be85" class="outline-4">
<h4 id="org811be85">Windows</h4>
</div>
<div id="outline-container-org7ee25d5" class="outline-4">
<h4 id="org7ee25d5">Java</h4>
</div>
<div id="outline-container-orgd7e6a73" class="outline-4">
<h4 id="orgd7e6a73">Implicit Threading</h4>
<div class="outline-text-4" id="text-orgd7e6a73">
<p>
A recent development in compilers and libraries put the management of threads in their hands. This allows a programmer to code normally, not worrying about threads, but threads will be created for them by the compiler. This is referred to as <b>Implicit Threading</b> since it happens without the programmer expressly creating threads.
</p>
</div>
</div>
</div>

<div id="outline-container-orgbadd807" class="outline-3">
<h3 id="orgbadd807">Thread Pools</h3>
<div class="outline-text-3" id="text-orgbadd807">
<p>
Instead of creating a thread every time we need one, an amount of threads are created on startup and wait for work to be assigned to them
</p>
<ul class="org-ul">
<li>Modifying an existing thread is faster than creating one</li>
<li>Limits the number of threads that can exist at any given point</li>
</ul>
</div>
</div>
<div id="outline-container-orga8f9697" class="outline-3">
<h3 id="orga8f9697">Issues</h3>
<div class="outline-text-3" id="text-orga8f9697">
</div>
<div id="outline-container-org8c1fe30" class="outline-4">
<h4 id="org8c1fe30">Process Creation Inside a Thread</h4>
<div class="outline-text-4" id="text-org8c1fe30">
<p>
If a thread calls <code>fork()</code>, does the new process have a duplicate of all the threads or none?
</p>
<ul class="org-ul">
<li>Some systems provide two functions for process creation, one for each case</li>
</ul>
</div>
</div>

<div id="outline-container-org3fcaa11" class="outline-4">
<h4 id="org3fcaa11">Signal Delivering</h4>
<div class="outline-text-4" id="text-org3fcaa11">
<p>
A <b>signal</b> is used to notify a process of some event. Once the event occurs, a signal is created, delivered to the process and then handled by the process. But what happens when a process has multiple threads, where should the <b>signal</b> be <i>delivered</i>?
</p>
<ul class="org-ul">
<li>To the thread that the signal applies too</li>
<li>Every thread in the process</li>
<li>Certain threads in the process</li>
<li>One thread to receive all signals</li>
</ul>
</div>
</div>

<div id="outline-container-org4908ff3" class="outline-4">
<h4 id="org4908ff3">Thread Cancellation</h4>
<div class="outline-text-4" id="text-org4908ff3">
<p>
Killing a <i>thread</i> before it has completed is <b>thread cancellation</b>, it is handled in two different ways:
</p>
<dl class="org-dl">
<dt>Asynchronous Cancellation</dt><dd>A thread kills the target thread immediately</dd>
<dt>Deferred Cancellation</dt><dd>The target thread periodically checks if it needs to be terminated and then handles it itself</dd>
</dl>

<p>
The issue with <b>thread cancellation</b> happens specifically with <b>asynchronous cancellation</b>: if a thread using a system resource is killed, the system resource may not be freed.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Jackson Daumeyer</p>
<p class="date">Created: 2023-03-01 Wed 10:52</p>
</div>
</body>
</html>
